---
title: "PoissonAnalysis"
author: "Alejandro AÃ­sa"
date: "`r Sys.Date()`"
output: pdf_document 
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

The following correspond to the section II of the master's thesis. More specifically, this part of the code is devoted to the construction of various generalized linear models to analyse the effect of football matches in protests. 

```{r message=FALSE, warning=FALSE}
library(caret)
library(pscl)
library(MASS)
library(msme)
library(car)
library(RcppRoll)
library(modelsummary)
library(kableExtra)
library(tidyverse)
```

## Models 

### Loading Data 

For this section of the thesis we load the database concerning the matches of Cliftonville AFC. in order to allow the regression to work, some variables are recoded as factor. We also include the lagged variables. 

Similarly, matches are usually played on Sundays. Thus, we establish that the variable to predict is the number of protests of next week. Similarly, some week-district had two matches. However, they cannot be remove as they entail different events, which can affect very differently. 

```{r}
Cliftonville <- read.csv("Databases/Final_Cliftonville.csv") %>% 
  dplyr::select(-X) %>% 
  mutate(
    is_protest = as_factor(is_protest), 
    CliftonvilleHome = as_factor(CliftonvilleHome), 
    CliftonvilleWin = as_factor(CliftonvilleWin), 
    pcg_catholics = pcg_catholics/100) %>%  
  group_by(District) %>% 
  mutate(
    protests = lead(n_protests, n = 1), 
    lagged_month = roll_sum(n_protests, n = 3, 
                                         align = "right", fill = NA)) %>% 
  ungroup %>% 
  replace_na(
    list(
      protests = 0, 
      lagged_month = 0, 
      Distance_km = 46)) %>% 
  ungroup() %>% 
  dplyr::rename(
    lagged_week = n_protests)

```

## Description 

Before the analysis, it was necessary to get a glimpse of the data. 

### Binary 

```{r}
data.frame(table(Cliftonville$is_protest));histogram(Cliftonville$is_protest)
```

### Count 

```{r}
data.frame(table(Cliftonville$protests)); histogram(Cliftonville$protests)

var(Cliftonville$protests)/mean(Cliftonville$protests) 

```

The previous information demonstrates the high number of week-districts without protests and the over dispersion of data. Hence why Negative Binomial and Zero-Inflated models will be constructed. 

### Keeping only numeric data 

For software purposes, only numeric data kept. 

```{r}
data <- Cliftonville %>% 
  dplyr::select(-week, -District, -n_protesters) %>% 
  transmute(
    protests, 
    is_protest, 
    CHome = CliftonvilleHome, 
    CWin = CliftonvilleWin, 
    pcg_catholics, 
    pcg_car, 
    pcg_unem = pcg_Unem, 
    distance = Distance_km, 
    lagged_week,
    lagged_month)
  
```

## Models 

Final step is to construct the various models, in increasing complexity. 

### Single model 

```{r}
single <- glm(
  is_protest ~
    CHome + 
    CWin, 
  data = data, 
  family = "binomial")

summary(single)

```



### Logistic 

```{r}
log_NI <- glm(
  is_protest ~
    CHome + 
    CWin +
    CHome*CWin +
    pcg_catholics +
    pcg_car +
    pcg_unem + 
    distance,  
  data = data, 
  family = "binomial") 

summary(log_NI)

```

```{r}
probabilities <- log_NI %>% predict(data, type = "response")

ggplot(data, aes(x = CHome, y = probabilities))+
  geom_boxplot(width = 0.3)+ 
  ylim(-0.5, 1)+
  theme_bw() ; 

ggplot(data, aes(x = CWin, y = probabilities))+
  geom_boxplot(width = 0.3)+ 
  ylim(0, 1.6)+
  theme_bw()
  
```



#### Goodness of fit 

```{r}
msme::P__disp(log_NI)
```

### Negative Binomial 

```{r}
NB_NI <- glm.nb(
  protests ~
    CHome + 
    CWin +
    CHome*CWin +
    pcg_catholics +
    pcg_car +
    pcg_unem + 
    distance + 
    lagged_week + 
    lagged_month, 
  data = data
)

summary(NB_NI)

```

#### Evaluation 

```{r}
exp(coefficients(NB_NI)); P__disp(NB_NI)

```


### Zero-Inflated Negative Binomial

```{r}
data2 <- data %>% dplyr::select(-is_protest)

ZI2_NI <- zeroinfl(
  protests ~
    CHome + 
    CWin +
    pcg_catholics +
    CHome*CWin +
    pcg_car +
    pcg_unem +
    distance + 
    lagged_week + 
    lagged_month |
    CHome + 
    CWin +
    pcg_catholics +
    pcg_car +
    pcg_unem + 
    distance, 
  data = data2, 
  dist="negbin", 
  link="logit")

summary(ZI2_NI)

```

```{r}
exp(coefficients(ZI2_NI))

P__disp(ZI2_NI)
```


### Additional models

#### Quassi Poisson Model 

```{r}
QP_NI <- glm(
  protests ~
    CHome + 
    CWin +
    CHome*CWin +
    pcg_catholics +
    pcg_car +
    pcg_unem + 
    distance + 
    lagged_week + 
    lagged_month,  
  data = data, 
  family = "quasipoisson", 
  control = list(maxit = 100))

summary(QP_NI)
```

```{r}
exp(coefficients(QP_NI))

P__disp(QP_NI) 

```

#### Zero-Inflated Poisson

```{r}
ZI_NI <- zeroinfl(
  protests ~
    CHome + 
    CWin +
    CHome*CWin + 
    pcg_catholics +
    pcg_car +
    pcg_unem +
    distance + 
    lagged_week + 
    lagged_month |
    CHome + 
    CWin +
    pcg_catholics +
    pcg_car +
    pcg_unem + 
    #lagged_week + 
    #lagged_month +
    distance, 
  data = data, 
  dist="poisson", 
  link="logit")

summary(ZI_NI)
```


```{r}
exp(coefficients(ZI_NI))

P__disp(ZI_NI)

```



